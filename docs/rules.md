# Cursor Rules ドキュメント

このドキュメントでは、`.cursor/rules/`ディレクトリ内のルールファイル（`.mdc`）について説明します。これらのルールは、Cursor AIがプロジェクトの開発ワークフローを自動化するために使用されます。

## 概要

`.cursor/rules/`ディレクトリには、プロジェクト開発における自動化ルールが定義されています。各ルールは`.mdc`形式で記述され、特定のワークフローやタスクの実行方法をAIに指示します。

## ルール一覧

### 1. change-plan.mdc

**目的**: 変更要件から仕様書を自動作成するルール

**機能**:
- ユーザーから変更要件を受け取ると、自動的に変更仕様書を作成
- バージョン番号の自動計算（`package.json`から取得してpatch番号をインクリメント）
- 日時の自動取得とフォーマット化
- サマリーの自動生成（キーワード抽出・ローマ字変換）

**生成されるファイル**:
- ファイル名形式: `v{version}_{date}_{time}_{summary}.md`
- 保存先: `changement/`ディレクトリ
- 例: `v00_01_31_20250126_1430_log_feature_addition.md`

**テンプレート構造**:
```markdown
# 変更仕様 v{version}: {summary}

## 背景
{変更要件の背景情報}

## 目的
{変更要件の目的}

## スコープ
{変更要件の適用範囲}

## 仕様（詳細）
{変更要件の詳細仕様}

## 受け入れ基準
{受け入れ基準}
```

**実行手順**:
1. `package.json`からバージョン取得
2. バージョンのpatch番号をインクリメント
3. 現在日時を取得・フォーマット
4. 変更要件からサマリー生成
5. 仕様書ファイルを作成

### 2. bump.mdc

**目的**: 変更仕様書のコミットとバージョンタグ付けの自動化

**機能**:
- `changement/`ディレクトリ内の最新の変更仕様書を自動検出
- 仕様書からバージョン・日付・変更内容を抽出
- コミットメッセージの自動生成
- Gitタグの自動作成

**実行方法**:
```bash
# 基本（最新仕様書を自動検出してコミット・タグ付け）
npm run commit-latest-spec

# 特定ファイルを指定
npm run commit-latest-spec -- --file changement/v00_01_30_log_injection.md

# コミット後にプッシュ（タグも含む）
npm run commit-latest-spec -- --push

# タグを作成しない場合
npm run commit-latest-spec -- --no-tag

# 実行内容を確認のみ（実際には実行しない）
npm run commit-latest-spec -- --dry-run
```

**コミットメッセージ形式**:
```
doc: {ファイル名} (v{バージョン})

日付: {YYYY-MM-DD}

変更内容:
{抽出した変更内容（最大10行）}
```

**タグ作成**:
- タグ名: `v{バージョン}`（例: `v0.1.30`）
- 仕様書から抽出したバージョンを使用
- 既存タグがある場合はスキップ

**情報抽出の優先順位**:
1. `## 変更` または `## 変更内容` セクション
2. `## 仕様`、`## 目的`、`## 要件`、`## スコープ` セクション
3. 見つからない場合はタイトルと最初の数行を使用

### 3. commit-spec.mdc

**目的**: 変更仕様書の自動コミット（簡易版）

**機能**:
- `changement/`ディレクトリ内の最新仕様書を検出
- Gitステージングとコミットを実行

**実行手順**:
1. `changement/`ディレクトリ内の`.md`ファイルを検索（`_`で始まらないもののみ）
2. 最終更新日時が最新のファイルを1件選択
3. `git add`でステージング
4. `git commit`でコミット（メッセージ: `doc: <ファイル名> added`）

**注意事項**:
- 対象ファイルが見つからない場合はスキップ（エラーにはしない）
- 既にコミット済みのファイルは正常に処理される（「nothing to commit」は正常動作）

### 4. vsix-update.mdc

**目的**: VSIXファイルのビルドと配布ワークフロー

**機能**:
- VSIXファイルのビルド手順の定義
- 変更仕様書のコミットとの連携ワークフロー
- リリースノートの自動注入

**推奨ワークフロー**:

```bash
# 1. 変更仕様書を編集
# ... changement/v00_01_31_feature_name.md を作成/編集 ...

# 2. VSIXファイルをビルド（この時点で package.json のバージョンが更新される）
npm run build-latest

# 3. 変更仕様書をコミット（更新されたバージョン情報がコミットメッセージとタグに反映される）
npm run commit-latest-spec -- --push

# 4. Cursor/VS Codeでインストール
# - 拡張機能タブ → 「...」 → 「VSIXからのインストール」
# - cursor-code-prettifier-latest.vsix を選択
```

**重要な順序**:
1. **変更仕様書の作成・編集**
2. **VSIXファイルのビルド**（`npm run build-latest`）
   - この時点で`package.json`のバージョンが更新される
   - リリースノートが自動注入される
3. **変更仕様書のコミットとタグ付け**（`npm run commit-latest-spec`）
   - 更新されたバージョン情報がコミットメッセージとタグに反映される

**ビルドコマンド**:

| コマンド | 説明 |
|---------|------|
| `npm run build-latest` | 固定名VSIXファイルを作成（推奨） |
| `npm run build-quick` | クイックビルド（バージョン更新なし） |
| `npm run build` | 通常ビルド（バージョン付きファイル名） |

**`build-latest`の実行内容**:
1. バージョン更新（`npm run bump-version`）
2. リリースノート注入（`scripts/inject-release-notes.js`）
3. TypeScriptのコンパイル（`npm run compile`）
4. VSIXパッケージの作成（`npx vsce package`）
5. 古いVSIXファイルを`old/`ディレクトリにアーカイブ
6. 最新のVSIXファイルを`cursor-code-prettifier-latest.vsix`にコピー

## ルールファイルの共通仕様

### ファイル形式

すべてのルールファイルは以下の形式で記述されます:

```markdown
---
alwaysApply: false
---

# ルールタイトル

ルールの説明...
```

- **`alwaysApply: false`**: このルールは常に適用されるのではなく、特定の条件やユーザー要求時にのみ適用されます

### ディレクトリ構造

```
.cursor/
└── rules/
    ├── change-plan.mdc      # 仕様書自動作成
    ├── bump.mdc             # コミット・タグ付け
    ├── commit-spec.mdc      # 簡易コミット
    └── vsix-update.mdc      # VSIX更新
```

## ワークフローの統合

これらのルールは通常、以下のような統合ワークフローで使用されます:

1. **機能開発開始**
   - ユーザーが変更要件を提示
   - `change-plan.mdc`が自動実行され、仕様書が作成される

2. **開発・テスト**
   - 仕様書に基づいて実装を進める
   - 必要に応じて仕様書を更新

3. **リリース準備**
   - `npm run build-latest`を実行（VSIXビルド + バージョン更新 + リリースノート注入）
   - `npm run commit-latest-spec -- --push`を実行（コミット + タグ付け + プッシュ）

4. **配布**
   - `cursor-code-prettifier-latest.vsix`をインストール

## 注意事項

### バージョン管理
- バージョン番号は`package.json`から動的に取得されます（固定値は使用しません）
- VSIXビルド時とコミット時の順序が重要です（ビルド → コミット）

### ファイル名の制約
- ファイル名に使用できない文字（`/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `|`）は含めません
- 日本語はローマ字表記または英語に変換されます

### エラーハンドリング
- 各ルールには適切なエラーハンドリングが実装されています
- エラー時は警告を表示しますが、できる限り処理を継続します

## 関連ドキュメント

- [設定リファレンス](configuration.md)
- [カスタマイズガイド](customization.md)
- [README](../README.md)

## スクリプトの場所

各ルールに対応するスクリプトは以下の場所にあります:

- `scripts/bump-version.js` - バージョン更新
- `scripts/commit-latest-spec.js` - コミット・タグ付け
- `scripts/inject-release-notes.js` - リリースノート注入
- `scripts/build-latest.js` - VSIXビルド（固定名）

これらのスクリプトは`package.json`で定義されたnpmスクリプトから呼び出されます。
