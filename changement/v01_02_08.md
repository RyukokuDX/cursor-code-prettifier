# 変更仕様 v1.2.8

## 要件
- 編集時にコードのマスク解除にラグがある
- カーソルオンしている行のマスクを解除することで、状況を改善したい
- マスク解除を自動でなく、キーによるトグルトリガーで行いたい
	- 行と全体は別

## 仕様（詳細）

### 目的とスコープ
- 編集時のマスク解除ラグを回避するため、自動解除をやめ、ユーザー操作（キー操作）で明示的に解除する。
- `refMaskMode: counter` を含む全置換表示に適用（見た目のみの置換）。

### コマンド（新規）
- Cursor Code Prettifier: Toggle Mask (Current Line)
  - コマンドID: `cursorCodePrettifier.toggleMaskLine`
  - 対象: 現在のカーソルがある行（複数選択時は全選択行）
  - 動作: 対象行のマスク状態をトグル（マスクON ⇄ OFF）
- Cursor Code Prettifier: Toggle Mask (Document)
  - コマンドID: `cursorCodePrettifier.toggleMaskAll`
  - 対象: 現在アクティブなドキュメント
  - 動作: ドキュメント全体のマスク状態をトグル（マスクON ⇄ OFF）

### 既存の自動解除の扱い
- ホバー/キャレット移動による一時解除はデフォルトで無効化。
- トグルの有効期間中は自動解除を行わない。

### マスク解除の粒度と優先順位
- 優先順位: ドキュメント全体トグル（最上位） > 行トグル > 通常マスク。
- ドキュメント全体OFFなら全行でマスクは表示されない（元のLaTeX表示）。
- ドキュメントONかつ行トグルOFFの行のみ、元のLaTeX表示（他行はマスク表示）。

### 永続性（セッション内）
- 行トグル状態: セッション内でドキュメントを開いている間のみ有効（再読み込みでクリア）。
- ドキュメント全体トグル: セッション内で当該ドキュメントに対して維持（再読み込みで初期ONに戻す）。
- 永続化は行わない（ファイル/設定への保存なし）。

### 表示仕様（counter モード含む）
- マスクON:
  - `\ref{label}` → 番号 `n`、`\eqref{label}` → `(n)`。
  - 複数ラベル（`,`/`;` 区切り）は `n1,n2` と結合（eqref は `(n1,n2)`）。
  - 文字色の控えめ強調のみ適用（背景・枠線・絵文字は不採用）。
- マスクOFF（行／全体）:
  - 装飾を抑制し、常に元のLaTeXテキストを表示。

### 設定（最終仕様）
- `cursorCodePrettifier.counterHighlightEnabled: boolean`（既定: true）
  - counterモードの置換番号に文字色を適用するか。
- `cursorCodePrettifier.counterTextColor: string`（既定: `#7aa2f7`）
  - 文字色（CSSカラー）。

### `.aux` の探索・マージと運用
- 優先順で `.aux` 候補を探索:
  1) 編集中 `.tex` と同ディレクトリの `.aux`
  2) `latex-workshop.latex.outDir` を編集中ファイル基準（%DIR%）で解決した出力先 `.aux`
  3) ルート `.tex` 隣接 `.aux`
  4) `outDir` をルート基準で解決した `.aux`
  5) 近接ディレクトリ優先でワークスペース全体を走査
- 見つかった `.aux` を基に、ワークスペース内の他の `.aux` をマージして不足ラベルを補完（先勝ち）。
- 監視: `.aux` 作成/変更でキャッシュ更新、削除ではキャッシュ温存。
- 推奨: ビルド後 `.aux` を残す（Latex-Workshop のクリーン無効化、fileTypesからaux除外、latexmkrc設定など）。

### キーバインド（推奨例・デフォルトなし）
- Toggle Mask (Current Line): 例 `Ctrl+Alt+M`。
- Toggle Mask (Document): 例 `Ctrl+Alt+Shift+M`。

### ログ（Prettifier 出力）
- 設定: `refMaskMode`, `counterHighlightEnabled`, `counterTextColor`。
- `.aux`: `aux file: ... labels=...`、`aux merged labels: ...`。
- 置換統計: `refs: total=..., matched=..., missing=...`。
- 装飾統計: `decorations: total=..., effective=...`。
- トグル実行: `line: toggled lines=<n> → on/off`、`doc: toggled document → on/off`。

### 受け入れ基準
- 行トグル: 当該行のみ元のLaTeX表示。他行はマスク表示のまま。
- 全体トグル: ドキュメント全体で元のLaTeX表示。再トグルで元に戻る。
- counterモード: マスクONで番号表示＋文字色強調、OFFで `\ref{...}`/`\eqref{...}` が見える。
- サブディレクトリ/`outDir` 利用時でも最新 `.aux` が優先され、`matched` が期待どおり増加。